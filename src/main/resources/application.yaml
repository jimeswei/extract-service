# ========================================
# æ™ºèƒ½æ–‡æœ¬æå–æœåŠ¡ v4.0 - æ–‡ä»¶æ¶æ„é…ç½®
# ğŸ”§ æ— æ•°æ®åº“ä¾èµ– + ğŸš€ åŸºäºæ–‡ä»¶çš„å¤„ç†æ¶æ„
# ========================================

# é»˜è®¤æ¿€æ´»å¼€å‘ç¯å¢ƒ
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:default}
  main:
    allow-bean-definition-overriding: true
  application:
    name: extract-service-v4
    
  # Redisé…ç½® - v4.0æ€§èƒ½ä¼˜åŒ–
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 10
          max-idle: 8
          min-idle: 2
          max-wait: 3000ms

# é€šç”¨æœåŠ¡å™¨é…ç½®
server:
  port: ${SERVER_PORT:2701}

# é€šç”¨ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# é€šç”¨æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.datacenter.extract: INFO
    org.springframework: WARN
    reactor.netty: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{50}] - %msg%n"
  file:
    name: ${LOG_FILE:./log/extract_service.log}
    max-size: 100MB
    max-history: ${LOG_MAX_HISTORY:10}

# AIé…ç½®
extraction:
  ai:
    providers:
      deepseek:
        api-key: ${DEEPSEEK_API_KEY:sk-d91a0452893f43c596b5071c66cc2cd9}  # å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®
        url: ${DEEPSEEK_API_URL:https://api.deepseek.com/v1/chat/completions}
        base-timeout: ${AI_BASE_TIMEOUT:30s}
        max-timeout: ${AI_MAX_TIMEOUT:180s}
        retry-count: ${AI_RETRY_COUNT:3}
        max-concurrent-calls: ${AI_MAX_CONCURRENT:3}
        enable-metrics: true
        fallback-enabled: true
        error-handling:
          max-retries: ${AI_MAX_RETRIES:4}
          retry-delay: ${AI_RETRY_DELAY:2s}
          max-retry-delay: ${AI_MAX_RETRY_DELAY:30s}
          timeout-per-1000-chars: ${AI_TIMEOUT_PER_1000_CHARS:10s}

# æ–‡ä»¶å¤„ç†é…ç½® - v4.0æ–°å¢
file:
  processing:
    output-dir: ${OUTPUT_DIR:./out}
    template-dir: ${TEMPLATE_DIR:./src/main/resources/templates}
    batch-size: ${BATCH_SIZE:10}
    max-file-size: ${MAX_FILE_SIZE:50MB}
    cleanup-enabled: ${FILE_CLEANUP_ENABLED:true}
    cleanup-days: ${FILE_CLEANUP_DAYS:7}
    auto-create-dirs: true
    # å…¼å®¹é…ç½®
    output-directory: ${OUTPUT_DIR:./out}
    template-directory: ${TEMPLATE_DIR:./src/main/resources/templates}

# ç¼“å­˜é…ç½® - v4.0æ€§èƒ½ä¼˜åŒ–
cache:
  # åˆ†å±‚ç¼“å­˜ç­–ç•¥: L1(Caffeineæœ¬åœ°) + L2(Redisåˆ†å¸ƒå¼)
  strategy: ${CACHE_STRATEGY:hybrid}  # hybrid, caffeine-only, redis-only
  
  caffeine:
    default:
      maximum-size: ${CACHE_DEFAULT_SIZE:1000}
      expire-after-write: 1h
    template:
      maximum-size: 100
      expire-after-write: 24h
    ai-result:
      maximum-size: 1000
      expire-after-write: 2h
      
  redis:
    enabled: ${REDIS_CACHE_ENABLED:true}
    ttl:
      ai-result: 7200s      # AIç»“æœç¼“å­˜2å°æ—¶
      template: 86400s      # æ¨¡æ¿ç¼“å­˜24å°æ—¶
      text-chunk: 3600s     # æ–‡æœ¬åˆ†ç‰‡ç¼“å­˜1å°æ—¶
      default: 1800s        # é»˜è®¤ç¼“å­˜30åˆ†é’Ÿ
      key-prefix: "extract:v4:"

# æ¨¡æ¿é…ç½® - v4.0æ ¸å¿ƒ
template:
  supported-types:
    - celebrity
    - celebrityCelebrity
    - work
    - event
    - triples
  hot-reload: ${TEMPLATE_HOT_RELOAD:true}
  validation-enabled: ${TEMPLATE_VALIDATION:true}

---
# ========================================
# ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½® (Profile: production)
# ========================================
spring:
  config:
    activate:
      on-profile: production

# ç”Ÿäº§æœåŠ¡å™¨é…ç½®
server:
  port: 2701
  servlet:
    context-path: /
  tomcat:
    threads:
      max: 200
      min-spare: 50
    max-connections: 10000
    accept-count: 100
    connection-timeout: 20000
    max-http-form-post-size: 50MB
    max-swallow-size: 50MB
    uri-encoding: UTF-8

# ç”Ÿäº§ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,loggers,threaddump,heapdump,caches
  endpoint:
    health:
      show-details: always
    metrics:
      enabled: true
  metrics:
    distribution:
      percentiles:
        http.server.requests: 0.5,0.95,0.99
  prometheus:
    metrics:
      export:
        enabled: true

# ç”Ÿäº§æ—¥å¿—é…ç½®
logging:
  level:
    com.datacenter.extract: INFO
    org.springframework: WARN
    org.apache.tomcat: WARN
    reactor.netty: WARN
  file:
    name: logs/extract-service.log
    max-history: 30

# ç”Ÿäº§AIé…ç½®
extraction:
  ai:
    providers:
      deepseek:
        timeout-per-1000-chars: 10s
        retry-count: 4
        retry-base-delay: 2s
        retry-max-delay: 30s
        max-concurrent-calls: 8
        
  # æ–‡æœ¬å¤„ç†é…ç½®
  processing:
    batch-size: 20
    parallel-threads: 8
    timeout: 120s
    max-text-length: 50000
    chunk-size: 2000
    chunk-overlap: 200
    
  # ç½‘ç»œé…ç½®ä¼˜åŒ–
  webclient:
    connection-pool:
      max-connections: 50
      max-idle-time: 30s
      max-lifetime: 60s
      pending-acquire-timeout: 60s
    timeout:
      connect: 10s
      read: 180s
      write: 60s
    buffer:
      max-in-memory-size: 10MB

# ç”Ÿäº§æ–‡ä»¶å¤„ç†é…ç½®
file:
  processing:
    output-dir: /data/extract-service/out
    template-dir: /app/templates
    batch-size: 50
    max-file-size: 100MB
    cleanup-enabled: true
    cleanup-days: 30
    compression-enabled: true
    backup-enabled: true
    backup-dir: /data/extract-service/backup

# ç”Ÿäº§ç¼“å­˜æ¶æ„
cache:
  caffeine:
    # ä¸»ç¼“å­˜
    l1-cache:
      maximum-size: 10000
      expire-after-write: 30m
      expire-after-access: 15m
      record-stats: true
    # AIç»“æœç¼“å­˜
    ai-result-cache:
      maximum-size: 5000
      expire-after-write: 2h
      expire-after-access: 1h
      record-stats: true
    # æ¨¡æ¿ç¼“å­˜
    template-cache:
      maximum-size: 200
      expire-after-write: 24h
      expire-after-access: 12h
      record-stats: true

# ç”Ÿäº§çº¿ç¨‹æ± é…ç½®
performance:
  threads:
    # ä¸»ä¸šåŠ¡çº¿ç¨‹æ± 
    main-business:
      core-size: 10
      max-size: 50
      queue-capacity: 200
      keep-alive-seconds: 60
      thread-name-prefix: "main-biz-"
      rejection-policy: "CallerRunsPolicy"
    # AIå¤„ç†çº¿ç¨‹æ± 
    ai-processing:
      core-size: 8
      max-size: 20
      queue-capacity: 100
      keep-alive-seconds: 120
      thread-name-prefix: "ai-proc-"
      rejection-policy: "CallerRunsPolicy"
    # æ–‡ä»¶å¤„ç†çº¿ç¨‹æ± 
    file-processing:
      core-size: 6
      max-size: 16
      queue-capacity: 80
      keep-alive-seconds: 60
      thread-name-prefix: "file-"
      rejection-policy: "CallerRunsPolicy"
      
  # ç›‘æ§é…ç½®
  monitoring:
    enabled: true
    metrics-interval: 30s
    threshold-alerts: true
    health-check-interval: 10s
    task-timeout-minutes: 5
    cleanup-interval-minutes: 10
    stats-cache-minutes: 1
    alert-failure-rate: 20.0

# ç”Ÿäº§å®‰å…¨é…ç½®
security:
  cors:
    allowed-origins: "*"
    allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
    allowed-headers: "*"
    max-age: 3600

# ç”Ÿäº§æ€§èƒ½æŒ‡æ ‡
metrics:
  performance:
    target-response-time-ms: 2000
    max-memory-usage-percent: 85
    min-success-rate-percent: 95
    alert-thresholds:
      response-time-p99: 5000
      error-rate: 5.0
      memory-usage: 90.0
      cache-hit-rate: 80.0

# MCP SSE ç”Ÿäº§é…ç½®
ai:
  mcp:
    server:
      name: intelligent-extraction-service-v4-prod
      type: ASYNC
      version: 4.0.0
      enabled: true
      sse-endpoint: /sse
      sse-message-endpoint: /mcp/message
      request-timeout: 180000
      max-connections: 200
      capabilities:
        tool: true
        resource: true
        prompt: true
        completion: true
        template-based: true
        file-output: true

# ä¸šåŠ¡åŠŸèƒ½é…ç½® - v4.0ç®€åŒ–ç‰ˆ
business:
  # åŠŸèƒ½å¼€å…³
  features:
    template-based-extraction: true
    batch-processing: true
    file-output: true
    
  # å¤„ç†æ¨¡å¼é…ç½®
  processing-modes:
    standard:
      enabled: true
      description: "æ ‡å‡†æ¨¡æ¿æå–"
    batch:
      enabled: true
      description: "æ‰¹é‡æ–‡ä»¶å¤„ç†"
      
  # è´¨é‡æ§åˆ¶
  quality-control:
    min-confidence-score: 0.7
    max-processing-time-ms: 300000
    enable-auto-retry: true
    file-validation: true

# å¼‚æ­¥ä»»åŠ¡é…ç½®
async:
  task:
    core-pool-size: 10
    max-pool-size: 50
    queue-capacity: 500
    thread-name-prefix: "async-task-"

---
# ========================================
# ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½® (Profile: default)
# ========================================
spring:
  config:
    activate:
      on-profile: default

# å¼€å‘æ–‡ä»¶å¤„ç†é…ç½®
file:
  processing:
    output-dir: ./out
    cleanup-enabled: false
    compression-enabled: false
    backup-enabled: false

# å¼€å‘æ¨¡æ¿é…ç½®
template:
  hot-reload: true
  validation-enabled: false
