# ========================================
# æ™ºèƒ½æ–‡æœ¬æå–æœåŠ¡ - ç»Ÿä¸€é…ç½®æ–‡ä»¶ v6.0
# ğŸ”§ åŸºç¡€é…ç½® + ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½® (æ¶ˆé™¤é‡å¤)
# ========================================

# é»˜è®¤æ¿€æ´»å¼€å‘ç¯å¢ƒ
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:default}
  main:
    allow-bean-definition-overriding: true
  
  application:
    name: extract-service
    
  # é€šç”¨æ•°æ®åº“é…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/${DB_NAME:extract-graph}?useUnicode=true&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:123456}
    
  # é€šç”¨JPAé…ç½®
  jpa:
    hibernate:
      ddl-auto: none
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: false
        
  # Redisé…ç½®
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 2000ms

# é€šç”¨æœåŠ¡å™¨é…ç½®
server:
  port: ${SERVER_PORT:2701}

# é€šç”¨ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# é€šç”¨æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.datacenter.extract: INFO
    org.springframework: WARN
    org.hibernate: WARN
    com.zaxxer.hikari: INFO
    reactor.netty: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{50}] - %msg%n"
  file:
    name: ${LOG_FILE:./log/extract_service.log}
    max-size: 100MB
    max-history: ${LOG_MAX_HISTORY:10}

# é€šç”¨AIé…ç½®
extraction:
  ai:
    providers:
      deepseek:
        api-key: ${DEEPSEEK_API_KEY:sk-cea6dbdbba694338b5f4abe9dfb0975b}
        url: https://api.deepseek.com/v1/chat/completions
        base-timeout: 30s
        max-timeout: 180s
        retry-count: ${AI_RETRY_COUNT:3}
        max-concurrent-calls: ${AI_MAX_CONCURRENT:3}
        enable-metrics: true
        fallback-enabled: true

# é€šç”¨ç¼“å­˜é…ç½®
cache:
  caffeine:
    default:
      maximum-size: ${CACHE_DEFAULT_SIZE:1000}
      expire-after-write: 1h

# é€šç”¨çŸ¥è¯†å›¾è°±é…ç½®
knowledge-graph:
  enabled: true
  disambiguation:
    threshold: ${KG_DISAMBIGUATION_THRESHOLD:0.7}
    max-candidates: ${KG_MAX_CANDIDATES:5}
    cache-enabled: ${KG_CACHE_ENABLED:false}
  fusion:
    conflict-resolution: "confidence-weighted"
    enable-quality-assessment: ${KG_QUALITY_ASSESSMENT:false}
    batch-processing: ${KG_BATCH_PROCESSING:false}
  quality:
    min-score: 0.6
    assessment-interval: 1h

---
# ========================================
# ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½® (Profile: production)
# ========================================
spring:
  config:
    activate:
      on-profile: production
  
  # ç”Ÿäº§æ•°æ®åº“ä¼˜åŒ–
  datasource:
    url: jdbc:mysql://localhost:3306/${DB_NAME:extraction_db}?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true&cachePrepStmts=true&useServerPrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048
    username: ${DB_USERNAME:extract_user}
    password: ${DB_PASSWORD:extract_2024}
    # HikariCP é«˜æ€§èƒ½è¿æ¥æ± 
    hikari:
      maximum-pool-size: 30
      minimum-idle: 10
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-timeout: 30000
      validation-timeout: 5000
      leak-detection-threshold: 60000
      connection-test-query: SELECT 1
      auto-commit: true
      pool-name: ExtractServicePool-Production
      
  # JPAç”Ÿäº§ä¼˜åŒ–
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        show_sql: false
        use_sql_comments: false
        # æ‰¹å¤„ç†ä¼˜åŒ–
        jdbc:
          batch_size: 50
          fetch_size: 50
          batch_versioned_data: true
        order_inserts: true
        order_updates: true
        # äºŒçº§ç¼“å­˜
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region.factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        temp:
          use_jdbc_metadata_defaults: false

# ç”Ÿäº§æœåŠ¡å™¨é…ç½®
server:
  port: 8080
  servlet:
    context-path: /
  tomcat:
    threads:
      max: 200
      min-spare: 50
    max-connections: 10000
    accept-count: 100
    connection-timeout: 20000
    max-http-form-post-size: 50MB
    max-swallow-size: 50MB
    uri-encoding: UTF-8

# ç”Ÿäº§ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,loggers,threaddump,heapdump,caches
  endpoint:
    health:
      show-details: always
    metrics:
      enabled: true
  metrics:
    distribution:
      percentiles:
        http.server.requests: 0.5,0.95,0.99
  prometheus:
    metrics:
      export:
        enabled: true

# ç”Ÿäº§æ—¥å¿—é…ç½®
logging:
  level:
    com.datacenter.extract: INFO
    org.springframework: WARN
    org.hibernate: WARN
    org.apache.tomcat: WARN
    reactor.netty: WARN
    com.zaxxer.hikari: WARN
  file:
    name: logs/extract-service.log
    max-history: 30

# ç”Ÿäº§AIé…ç½®
extraction:
  ai:
    providers:
      deepseek:
        timeout-per-1000-chars: 10s
        retry-count: 4
        retry-base-delay: 2s
        retry-max-delay: 30s
        max-concurrent-calls: 8
        
  # æ–‡æœ¬å¤„ç†é…ç½®
  processing:
    batch-size: 20
    parallel-threads: 8
    timeout: 120s
    max-text-length: 50000
    chunk-size: 2000
    chunk-overlap: 200
    
  # ç½‘ç»œé…ç½®ä¼˜åŒ–
  webclient:
    connection-pool:
      max-connections: 50
      max-idle-time: 30s
      max-lifetime: 60s
      pending-acquire-timeout: 60s
    timeout:
      connect: 10s
      read: 180s
      write: 60s
    buffer:
      max-in-memory-size: 10MB

# ç”Ÿäº§çŸ¥è¯†å›¾è°±é…ç½®
knowledge-graph:
  disambiguation:
    threshold: 0.8
    max-candidates: 3
    cache-enabled: true
    similarity-algorithm: "bert-cosine"
  fusion:
    enable-quality-assessment: true
    batch-processing: true
    confidence-threshold: 0.75
  quality:
    min-score: 0.7
    assessment-interval: "2h"
    auto-improvement: true
  reasoning:
    enabled: true
    max-depth: 3
    confidence-threshold: 0.6

# ç”Ÿäº§ç¼“å­˜æ¶æ„
cache:
  caffeine:
    # L1 ä¸»ç¼“å­˜
    l1-cache:
      maximum-size: 10000
      expire-after-write: 30m
      expire-after-access: 15m
      record-stats: true
    # AIç»“æœç¼“å­˜
    ai-result-cache:
      maximum-size: 5000
      expire-after-write: 2h
      expire-after-access: 1h
      record-stats: true
    # å®ä½“æ¶ˆæ­§ä¹‰ç¼“å­˜
    disambiguation-cache:
      maximum-size: 2000
      expire-after-write: 6h
      expire-after-access: 3h
      record-stats: true
    # ç›¸ä¼¼åº¦è®¡ç®—ç¼“å­˜
    similarity-cache:
      maximum-size: 10000
      expire-after-write: 4h
      expire-after-access: 2h
      record-stats: true

# ç”Ÿäº§çº¿ç¨‹æ± é…ç½®
performance:
  threads:
    # ä¸»ä¸šåŠ¡çº¿ç¨‹æ± 
    main-business:
      core-size: 10
      max-size: 50
      queue-capacity: 200
      keep-alive-seconds: 60
      thread-name-prefix: "main-biz-"
      rejection-policy: "CallerRunsPolicy"
    # AIå¤„ç†çº¿ç¨‹æ± 
    ai-processing:
      core-size: 8
      max-size: 20
      queue-capacity: 100
      keep-alive-seconds: 120
      thread-name-prefix: "ai-proc-"
      rejection-policy: "CallerRunsPolicy"
    # æ•°æ®åº“çº¿ç¨‹æ± 
    database:
      core-size: 5
      max-size: 15
      queue-capacity: 50
      keep-alive-seconds: 300
      thread-name-prefix: "db-"
      rejection-policy: "CallerRunsPolicy"
      
  # ç›‘æ§é…ç½®
  monitoring:
    enabled: true
    metrics-interval: 30s
    threshold-alerts: true
    health-check-interval: 10s
    task-timeout-minutes: 5
    cleanup-interval-minutes: 10
    stats-cache-minutes: 1
    alert-failure-rate: 20.0

# ç”Ÿäº§å®‰å…¨é…ç½®
security:
  cors:
    allowed-origins: "*"
    allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
    allowed-headers: "*"
    max-age: 3600

# ç”Ÿäº§æ€§èƒ½æŒ‡æ ‡
metrics:
  performance:
    target-response-time-ms: 2000
    max-memory-usage-percent: 85
    min-success-rate-percent: 95
    alert-thresholds:
      response-time-p99: 5000
      error-rate: 5.0
      memory-usage: 90.0
      cache-hit-rate: 80.0

# MCP SSE ç”Ÿäº§é…ç½®
ai:
  mcp:
    server:
      name: intelligent-extraction-service-prod
      type: ASYNC
      version: 6.0.0
      enabled: true
      sse-endpoint: /sse
      sse-message-endpoint: /mcp/message
      request-timeout: 180000
      max-connections: 200
      capabilities:
        tool: true
        resource: true
        prompt: true
        completion: true
        reasoning: true
        knowledge-graph: true

# ä¸šåŠ¡åŠŸèƒ½é…ç½®
business:
  # åŠŸèƒ½å¼€å…³
  features:
    entity-disambiguation: true
    knowledge-fusion: true
    relation-validation: true
    quality-assessment: true
    batch-processing: true
    
  # å¤„ç†æ¨¡å¼é…ç½®
  processing-modes:
    standard:
      enabled: true
      description: "æ ‡å‡†AIæå–"
    enhanced:
      enabled: true
      description: "AI + å®ä½“æ¶ˆæ­§ä¹‰ + å…³ç³»éªŒè¯"
    fusion:
      enabled: true
      description: "å®Œæ•´çŸ¥è¯†å›¾è°±å¤„ç†é“¾"
    batch:
      enabled: true
      description: "æ‰¹é‡å¤„ç†æ¨¡å¼"
      
  # è´¨é‡æ§åˆ¶
  quality-control:
    min-confidence-score: 0.7
    max-processing-time-ms: 300000
    enable-auto-retry: true
    enable-human-review: false

# å¼‚æ­¥ä»»åŠ¡é…ç½®
async:
  task:
    core-pool-size: 10
    max-pool-size: 50
    queue-capacity: 500
    thread-name-prefix: "async-task-"

---
# ========================================
# ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½® (Profile: default)
# ========================================
spring:
  config:
    activate:
      on-profile: default
  
  # å¼€å‘æ•°æ®åº“é…ç½®
  datasource:
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-timeout: 30000
      validation-timeout: 5000
